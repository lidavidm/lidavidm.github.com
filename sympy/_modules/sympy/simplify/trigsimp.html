<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>sympy.simplify.trigsimp &mdash; SymPy 1.0 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="http://95.sympy-live-tests.appspot.com/static/live-core.css" type="text/css" />
    <link rel="stylesheet" href="http://95.sympy-live-tests.appspot.com/static/live-autocomplete.css" type="text/css" />
    <link rel="stylesheet" href="http://95.sympy-live-tests.appspot.com/static/live-sphinx.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="http://95.sympy-live-tests.appspot.com/static/utilities.js"></script>
    <script type="text/javascript" src="http://95.sympy-live-tests.appspot.com/static/external/classy.js"></script>
    <script type="text/javascript" src="http://95.sympy-live-tests.appspot.com/static/live-core.js"></script>
    <script type="text/javascript" src="http://95.sympy-live-tests.appspot.com/static/live-autocomplete.js"></script>
    <script type="text/javascript" src="http://95.sympy-live-tests.appspot.com/static/live-sphinx.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML-full"></script>
    <link rel="shortcut icon" href="../../../_static/sympy-notailtext-favicon.ico"/>
    <link rel="top" title="SymPy 1.0 documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" />
   
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for sympy.simplify.trigsimp</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">division</span>

<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>

<span class="kn">from</span> <span class="nn">sympy.core.cache</span> <span class="kn">import</span> <span class="n">cacheit</span>
<span class="kn">from</span> <span class="nn">sympy.core</span> <span class="kn">import</span> <span class="p">(</span><span class="n">sympify</span><span class="p">,</span> <span class="n">Basic</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">Expr</span><span class="p">,</span> <span class="n">expand_mul</span><span class="p">,</span> <span class="n">factor_terms</span><span class="p">,</span>
    <span class="n">Mul</span><span class="p">,</span> <span class="n">Dummy</span><span class="p">,</span> <span class="n">igcd</span><span class="p">,</span> <span class="n">FunctionClass</span><span class="p">,</span> <span class="n">Add</span><span class="p">,</span> <span class="n">symbols</span><span class="p">,</span> <span class="n">Wild</span><span class="p">,</span> <span class="n">expand</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">sympy.core.compatibility</span> <span class="kn">import</span> <span class="nb">reduce</span><span class="p">,</span> <span class="n">iterable</span>
<span class="kn">from</span> <span class="nn">sympy.core.numbers</span> <span class="kn">import</span> <span class="n">I</span><span class="p">,</span> <span class="n">Integer</span>
<span class="kn">from</span> <span class="nn">sympy.core.function</span> <span class="kn">import</span> <span class="n">count_ops</span><span class="p">,</span> <span class="n">_mexpand</span>
<span class="kn">from</span> <span class="nn">sympy.functions.elementary.trigonometric</span> <span class="kn">import</span> <span class="n">TrigonometricFunction</span>
<span class="kn">from</span> <span class="nn">sympy.functions.elementary.hyperbolic</span> <span class="kn">import</span> <span class="n">HyperbolicFunction</span>
<span class="kn">from</span> <span class="nn">sympy.functions</span> <span class="kn">import</span> <span class="n">sin</span><span class="p">,</span> <span class="n">cos</span><span class="p">,</span> <span class="n">exp</span><span class="p">,</span> <span class="n">cosh</span><span class="p">,</span> <span class="n">tanh</span><span class="p">,</span> <span class="n">sinh</span><span class="p">,</span> <span class="n">tan</span><span class="p">,</span> <span class="n">cot</span><span class="p">,</span> <span class="n">coth</span>

<span class="kn">from</span> <span class="nn">sympy.strategies.core</span> <span class="kn">import</span> <span class="n">identity</span>
<span class="kn">from</span> <span class="nn">sympy.strategies.tree</span> <span class="kn">import</span> <span class="n">greedy</span>


<span class="kn">from</span> <span class="nn">sympy.polys.polyerrors</span> <span class="kn">import</span> <span class="n">PolificationFailed</span>
<span class="kn">from</span> <span class="nn">sympy.polys.polytools</span> <span class="kn">import</span> <span class="n">groebner</span>
<span class="kn">from</span> <span class="nn">sympy.polys.domains</span> <span class="kn">import</span> <span class="n">ZZ</span>
<span class="kn">from</span> <span class="nn">sympy.polys</span> <span class="kn">import</span> <span class="n">factor</span><span class="p">,</span> <span class="n">cancel</span><span class="p">,</span> <span class="n">parallel_poly_from_expr</span>

<span class="kn">from</span> <span class="nn">sympy.utilities.misc</span> <span class="kn">import</span> <span class="n">debug</span>



<span class="k">def</span> <span class="nf">trigsimp_groebner</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">hints</span><span class="o">=</span><span class="p">[],</span> <span class="n">quick</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s2">&quot;grlex&quot;</span><span class="p">,</span>
                      <span class="n">polynomial</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simplify trigonometric expressions using a groebner basis algorithm.</span>

<span class="sd">    This routine takes a fraction involving trigonometric or hyperbolic</span>
<span class="sd">    expressions, and tries to simplify it. The primary metric is the</span>
<span class="sd">    total degree. Some attempts are made to choose the simplest possible</span>
<span class="sd">    expression of the minimal degree, but this is non-rigorous, and also</span>
<span class="sd">    very slow (see the ``quick=True`` option).</span>

<span class="sd">    If ``polynomial`` is set to True, instead of simplifying numerator and</span>
<span class="sd">    denominator together, this function just brings numerator and denominator</span>
<span class="sd">    into a canonical form. This is much faster, but has potentially worse</span>
<span class="sd">    results. However, if the input is a polynomial, then the result is</span>
<span class="sd">    guaranteed to be an equivalent polynomial of minimal degree.</span>

<span class="sd">    The most important option is hints. Its entries can be any of the</span>
<span class="sd">    following:</span>

<span class="sd">    - a natural number</span>
<span class="sd">    - a function</span>
<span class="sd">    - an iterable of the form (func, var1, var2, ...)</span>
<span class="sd">    - anything else, interpreted as a generator</span>

<span class="sd">    A number is used to indicate that the search space should be increased.</span>
<span class="sd">    A function is used to indicate that said function is likely to occur in a</span>
<span class="sd">    simplified expression.</span>
<span class="sd">    An iterable is used indicate that func(var1 + var2 + ...) is likely to</span>
<span class="sd">    occur in a simplified .</span>
<span class="sd">    An additional generator also indicates that it is likely to occur.</span>
<span class="sd">    (See examples below).</span>

<span class="sd">    This routine carries out various computationally intensive algorithms.</span>
<span class="sd">    The option ``quick=True`` can be used to suppress one particularly slow</span>
<span class="sd">    step (at the expense of potentially more complicated results, but never at</span>
<span class="sd">    the expense of increased total degree).</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>

<span class="sd">    &gt;&gt;&gt; from sympy.abc import x, y</span>
<span class="sd">    &gt;&gt;&gt; from sympy import sin, tan, cos, sinh, cosh, tanh</span>
<span class="sd">    &gt;&gt;&gt; from sympy.simplify.trigsimp import trigsimp_groebner</span>

<span class="sd">    Suppose you want to simplify ``sin(x)*cos(x)``. Naively, nothing happens:</span>

<span class="sd">    &gt;&gt;&gt; ex = sin(x)*cos(x)</span>
<span class="sd">    &gt;&gt;&gt; trigsimp_groebner(ex)</span>
<span class="sd">    sin(x)*cos(x)</span>

<span class="sd">    This is because ``trigsimp_groebner`` only looks for a simplification</span>
<span class="sd">    involving just ``sin(x)`` and ``cos(x)``. You can tell it to also try</span>
<span class="sd">    ``2*x`` by passing ``hints=[2]``:</span>

<span class="sd">    &gt;&gt;&gt; trigsimp_groebner(ex, hints=[2])</span>
<span class="sd">    sin(2*x)/2</span>
<span class="sd">    &gt;&gt;&gt; trigsimp_groebner(sin(x)**2 - cos(x)**2, hints=[2])</span>
<span class="sd">    -cos(2*x)</span>

<span class="sd">    Increasing the search space this way can quickly become expensive. A much</span>
<span class="sd">    faster way is to give a specific expression that is likely to occur:</span>

<span class="sd">    &gt;&gt;&gt; trigsimp_groebner(ex, hints=[sin(2*x)])</span>
<span class="sd">    sin(2*x)/2</span>

<span class="sd">    Hyperbolic expressions are similarly supported:</span>

<span class="sd">    &gt;&gt;&gt; trigsimp_groebner(sinh(2*x)/sinh(x))</span>
<span class="sd">    2*cosh(x)</span>

<span class="sd">    Note how no hints had to be passed, since the expression already involved</span>
<span class="sd">    ``2*x``.</span>

<span class="sd">    The tangent function is also supported. You can either pass ``tan`` in the</span>
<span class="sd">    hints, to indicate that than should be tried whenever cosine or sine are,</span>
<span class="sd">    or you can pass a specific generator:</span>

<span class="sd">    &gt;&gt;&gt; trigsimp_groebner(sin(x)/cos(x), hints=[tan])</span>
<span class="sd">    tan(x)</span>
<span class="sd">    &gt;&gt;&gt; trigsimp_groebner(sinh(x)/cosh(x), hints=[tanh(x)])</span>
<span class="sd">    tanh(x)</span>

<span class="sd">    Finally, you can use the iterable form to suggest that angle sum formulae</span>
<span class="sd">    should be tried:</span>

<span class="sd">    &gt;&gt;&gt; ex = (tan(x) + tan(y))/(1 - tan(x)*tan(y))</span>
<span class="sd">    &gt;&gt;&gt; trigsimp_groebner(ex, hints=[(tan, x, y)])</span>
<span class="sd">    tan(x + y)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO</span>
    <span class="c1">#  - preprocess by replacing everything by funcs we can handle</span>
    <span class="c1"># - optionally use cot instead of tan</span>
    <span class="c1"># - more intelligent hinting.</span>
    <span class="c1">#     For example, if the ideal is small, and we have sin(x), sin(y),</span>
    <span class="c1">#     add sin(x + y) automatically... ?</span>
    <span class="c1"># - algebraic numbers ...</span>
    <span class="c1"># - expressions of lowest degree are not distinguished properly</span>
    <span class="c1">#   e.g. 1 - sin(x)**2</span>
    <span class="c1"># - we could try to order the generators intelligently, so as to influence</span>
    <span class="c1">#   which monomials appear in the quotient basis</span>

    <span class="c1"># THEORY</span>
    <span class="c1"># ------</span>
    <span class="c1"># Ratsimpmodprime above can be used to &quot;simplify&quot; a rational function</span>
    <span class="c1"># modulo a prime ideal. &quot;Simplify&quot; mainly means finding an equivalent</span>
    <span class="c1"># expression of lower total degree.</span>
    <span class="c1">#</span>
    <span class="c1"># We intend to use this to simplify trigonometric functions. To do that,</span>
    <span class="c1"># we need to decide (a) which ring to use, and (b) modulo which ideal to</span>
    <span class="c1"># simplify. In practice, (a) means settling on a list of &quot;generators&quot;</span>
    <span class="c1"># a, b, c, ..., such that the fraction we want to simplify is a rational</span>
    <span class="c1"># function in a, b, c, ..., with coefficients in ZZ (integers).</span>
    <span class="c1"># (2) means that we have to decide what relations to impose on the</span>
    <span class="c1"># generators. There are two practical problems:</span>
    <span class="c1">#   (1) The ideal has to be *prime* (a technical term).</span>
    <span class="c1">#   (2) The relations have to be polynomials in the generators.</span>
    <span class="c1">#</span>
    <span class="c1"># We typically have two kinds of generators:</span>
    <span class="c1"># - trigonometric expressions, like sin(x), cos(5*x), etc</span>
    <span class="c1"># - &quot;everything else&quot;, like gamma(x), pi, etc.</span>
    <span class="c1">#</span>
    <span class="c1"># Since this function is trigsimp, we will concentrate on what to do with</span>
    <span class="c1"># trigonometric expressions. We can also simplify hyperbolic expressions,</span>
    <span class="c1"># but the extensions should be clear.</span>
    <span class="c1">#</span>
    <span class="c1"># One crucial point is that all *other* generators really should behave</span>
    <span class="c1"># like indeterminates. In particular if (say) &quot;I&quot; is one of them, then</span>
    <span class="c1"># in fact I**2 + 1 = 0 and we may and will compute non-sensical</span>
    <span class="c1"># expressions. However, we can work with a dummy and add the relation</span>
    <span class="c1"># I**2 + 1 = 0 to our ideal, then substitute back in the end.</span>
    <span class="c1">#</span>
    <span class="c1"># Now regarding trigonometric generators. We split them into groups,</span>
    <span class="c1"># according to the argument of the trigonometric functions. We want to</span>
    <span class="c1"># organise this in such a way that most trigonometric identities apply in</span>
    <span class="c1"># the same group. For example, given sin(x), cos(2*x) and cos(y), we would</span>
    <span class="c1"># group as [sin(x), cos(2*x)] and [cos(y)].</span>
    <span class="c1">#</span>
    <span class="c1"># Our prime ideal will be built in three steps:</span>
    <span class="c1"># (1) For each group, compute a &quot;geometrically prime&quot; ideal of relations.</span>
    <span class="c1">#     Geometrically prime means that it generates a prime ideal in</span>
    <span class="c1">#     CC[gens], not just ZZ[gens].</span>
    <span class="c1"># (2) Take the union of all the generators of the ideals for all groups.</span>
    <span class="c1">#     By the geometric primality condition, this is still prime.</span>
    <span class="c1"># (3) Add further inter-group relations which preserve primality.</span>
    <span class="c1">#</span>
    <span class="c1"># Step (1) works as follows. We will isolate common factors in the</span>
    <span class="c1"># argument, so that all our generators are of the form sin(n*x), cos(n*x)</span>
    <span class="c1"># or tan(n*x), with n an integer. Suppose first there are no tan terms.</span>
    <span class="c1"># The ideal [sin(x)**2 + cos(x)**2 - 1] is geometrically prime, since</span>
    <span class="c1"># X**2 + Y**2 - 1 is irreducible over CC.</span>
    <span class="c1"># Now, if we have a generator sin(n*x), than we can, using trig identities,</span>
    <span class="c1"># express sin(n*x) as a polynomial in sin(x) and cos(x). We can add this</span>
    <span class="c1"># relation to the ideal, preserving geometric primality, since the quotient</span>
    <span class="c1"># ring is unchanged.</span>
    <span class="c1"># Thus we have treated all sin and cos terms.</span>
    <span class="c1"># For tan(n*x), we add a relation tan(n*x)*cos(n*x) - sin(n*x) = 0.</span>
    <span class="c1"># (This requires of course that we already have relations for cos(n*x) and</span>
    <span class="c1"># sin(n*x).) It is not obvious, but it seems that this preserves geometric</span>
    <span class="c1"># primality.</span>
    <span class="c1"># XXX A real proof would be nice. HELP!</span>
    <span class="c1">#     Sketch that &lt;S**2 + C**2 - 1, C*T - S&gt; is a prime ideal of</span>
    <span class="c1">#     CC[S, C, T]:</span>
    <span class="c1">#     - it suffices to show that the projective closure in CP**3 is</span>
    <span class="c1">#       irreducible</span>
    <span class="c1">#     - using the half-angle substitutions, we can express sin(x), tan(x),</span>
    <span class="c1">#       cos(x) as rational functions in tan(x/2)</span>
    <span class="c1">#     - from this, we get a rational map from CP**1 to our curve</span>
    <span class="c1">#     - this is a morphism, hence the curve is prime</span>
    <span class="c1">#</span>
    <span class="c1"># Step (2) is trivial.</span>
    <span class="c1">#</span>
    <span class="c1"># Step (3) works by adding selected relations of the form</span>
    <span class="c1"># sin(x + y) - sin(x)*cos(y) - sin(y)*cos(x), etc. Geometric primality is</span>
    <span class="c1"># preserved by the same argument as before.</span>

    <span class="k">def</span> <span class="nf">parse_hints</span><span class="p">(</span><span class="n">hints</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Split hints into (n, funcs, iterables, gens).&quot;&quot;&quot;</span>
        <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">funcs</span><span class="p">,</span> <span class="n">iterables</span><span class="p">,</span> <span class="n">gens</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">hints</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">Integer</span><span class="p">)):</span>
                <span class="n">n</span> <span class="o">=</span> <span class="n">e</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">FunctionClass</span><span class="p">):</span>
                <span class="n">funcs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">iterable</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
                <span class="n">iterables</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>
                <span class="c1"># XXX sin(x+2y)?</span>
                <span class="c1"># Note: we go through polys so e.g.</span>
                <span class="c1"># sin(-x) -&gt; -sin(x) -&gt; sin(x)</span>
                <span class="n">gens</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">parallel_poly_from_expr</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">](</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span> <span class="o">+</span> <span class="p">[</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">](</span><span class="n">Add</span><span class="p">(</span><span class="o">*</span><span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))])[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">gens</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">gens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">n</span><span class="p">,</span> <span class="n">funcs</span><span class="p">,</span> <span class="n">iterables</span><span class="p">,</span> <span class="n">gens</span>

    <span class="k">def</span> <span class="nf">build_ideal</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">terms</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build generators for our ideal. Terms is an iterable with elements of</span>
<span class="sd">        the form (fn, coeff), indicating that we have a generator fn(coeff*x).</span>

<span class="sd">        If any of the terms is trigonometric, sin(x) and cos(x) are guaranteed</span>
<span class="sd">        to appear in terms. Similarly for hyperbolic functions. For tan(n*x),</span>
<span class="sd">        sin(n*x) and cos(n*x) are guaranteed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">gens</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">I</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">Dummy</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">fn</span><span class="p">,</span> <span class="n">coeff</span> <span class="ow">in</span> <span class="n">terms</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">rel</span> <span class="ow">in</span> <span class="p">(</span>
                    <span class="p">[</span><span class="n">cos</span><span class="p">,</span> <span class="n">sin</span><span class="p">,</span> <span class="n">tan</span><span class="p">,</span> <span class="n">cos</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span>
                    <span class="p">[</span><span class="n">cosh</span><span class="p">,</span> <span class="n">sinh</span><span class="p">,</span> <span class="n">tanh</span><span class="p">,</span> <span class="n">cosh</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">sinh</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">coeff</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">fn</span> <span class="ow">in</span> <span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">]:</span>
                    <span class="n">I</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rel</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">fn</span> <span class="o">==</span> <span class="n">t</span><span class="p">:</span>
                    <span class="n">I</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">(</span><span class="n">coeff</span><span class="o">*</span><span class="n">x</span><span class="p">)</span><span class="o">*</span><span class="n">c</span><span class="p">(</span><span class="n">coeff</span><span class="o">*</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="n">s</span><span class="p">(</span><span class="n">coeff</span><span class="o">*</span><span class="n">x</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">fn</span> <span class="ow">in</span> <span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">]:</span>
                    <span class="n">cn</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span><span class="n">coeff</span><span class="o">*</span><span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">trig</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
                    <span class="n">I</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fn</span><span class="p">(</span><span class="n">coeff</span><span class="o">*</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="n">cn</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">I</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">analyse_gens</span><span class="p">(</span><span class="n">gens</span><span class="p">,</span> <span class="n">hints</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Analyse the generators ``gens``, using the hints ``hints``.</span>

<span class="sd">        The meaning of ``hints`` is described in the main docstring.</span>
<span class="sd">        Return a new list of generators, and also the ideal we should</span>
<span class="sd">        work with.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># First parse the hints</span>
        <span class="n">n</span><span class="p">,</span> <span class="n">funcs</span><span class="p">,</span> <span class="n">iterables</span><span class="p">,</span> <span class="n">extragens</span> <span class="o">=</span> <span class="n">parse_hints</span><span class="p">(</span><span class="n">hints</span><span class="p">)</span>
        <span class="n">debug</span><span class="p">(</span><span class="s1">&#39;n=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">n</span><span class="p">,</span> <span class="s1">&#39;funcs:&#39;</span><span class="p">,</span> <span class="n">funcs</span><span class="p">,</span> <span class="s1">&#39;iterables:&#39;</span><span class="p">,</span>
              <span class="n">iterables</span><span class="p">,</span> <span class="s1">&#39;extragens:&#39;</span><span class="p">,</span> <span class="n">extragens</span><span class="p">)</span>

        <span class="c1"># We just add the extragens to gens and analyse them as before</span>
        <span class="n">gens</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">gens</span><span class="p">)</span>
        <span class="n">gens</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">extragens</span><span class="p">)</span>

        <span class="c1"># remove duplicates</span>
        <span class="n">funcs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">funcs</span><span class="p">))</span>
        <span class="n">iterables</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">iterables</span><span class="p">))</span>
        <span class="n">gens</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">gens</span><span class="p">))</span>

        <span class="c1"># all the functions we can do anything with</span>
        <span class="n">allfuncs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">sin</span><span class="p">,</span> <span class="n">cos</span><span class="p">,</span> <span class="n">tan</span><span class="p">,</span> <span class="n">sinh</span><span class="p">,</span> <span class="n">cosh</span><span class="p">,</span> <span class="n">tanh</span><span class="p">])</span>
        <span class="c1"># sin(3*x) -&gt; ((3, x), sin)</span>
        <span class="n">trigterms</span> <span class="o">=</span> <span class="p">[(</span><span class="n">g</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">as_coeff_mul</span><span class="p">(),</span> <span class="n">g</span><span class="o">.</span><span class="n">func</span><span class="p">)</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">gens</span>
                     <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">func</span> <span class="ow">in</span> <span class="n">allfuncs</span><span class="p">]</span>
        <span class="c1"># Our list of new generators - start with anything that we cannot</span>
        <span class="c1"># work with (i.e. is not a trigonometric term)</span>
        <span class="n">freegens</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">gens</span> <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">func</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">allfuncs</span><span class="p">]</span>
        <span class="n">newgens</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">trigdict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">coeff</span><span class="p">,</span> <span class="n">var</span><span class="p">),</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">trigterms</span><span class="p">:</span>
            <span class="n">trigdict</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">coeff</span><span class="p">,</span> <span class="n">fn</span><span class="p">))</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># the ideal</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">trigdict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># We have now assembeled a dictionary. Its keys are common</span>
            <span class="c1"># arguments in trigonometric expressions, and values are lists of</span>
            <span class="c1"># pairs (fn, coeff). x0, (fn, coeff) in trigdict means that we</span>
            <span class="c1"># need to deal with fn(coeff*x0). We take the rational gcd of the</span>
            <span class="c1"># coeffs, call it ``gcd``. We then use x = x0/gcd as &quot;base symbol&quot;,</span>
            <span class="c1"># all other arguments are integral multiples thereof.</span>
            <span class="c1"># We will build an ideal which works with sin(x), cos(x).</span>
            <span class="c1"># If hint tan is provided, also work with tan(x). Moreover, if</span>
            <span class="c1"># n &gt; 1, also work with sin(k*x) for k &lt;= n, and similarly for cos</span>
            <span class="c1"># (and tan if the hint is provided). Finally, any generators which</span>
            <span class="c1"># the ideal does not work with but we need to accomodate (either</span>
            <span class="c1"># because it was in expr or because it was provided as a hint)</span>
            <span class="c1"># we also build into the ideal.</span>
            <span class="c1"># This selection process is expressed in the list ``terms``.</span>
            <span class="c1"># build_ideal then generates the actual relations in our ideal,</span>
            <span class="c1"># from this list.</span>
            <span class="n">fns</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">val</span><span class="p">]</span>
            <span class="n">val</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">val</span><span class="p">]</span>
            <span class="n">gcd</span> <span class="o">=</span> <span class="nb">reduce</span><span class="p">(</span><span class="n">igcd</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
            <span class="n">terms</span> <span class="o">=</span> <span class="p">[(</span><span class="n">fn</span><span class="p">,</span> <span class="n">v</span><span class="o">/</span><span class="n">gcd</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">fns</span><span class="p">,</span> <span class="n">val</span><span class="p">)]</span>
            <span class="n">fs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">funcs</span> <span class="o">+</span> <span class="n">fns</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="p">([</span><span class="n">cos</span><span class="p">,</span> <span class="n">sin</span><span class="p">,</span> <span class="n">tan</span><span class="p">],</span> <span class="p">[</span><span class="n">cosh</span><span class="p">,</span> <span class="n">sinh</span><span class="p">,</span> <span class="n">tanh</span><span class="p">]):</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span> <span class="ow">in</span> <span class="n">fs</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">)):</span>
                    <span class="n">fs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                    <span class="n">fs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">fs</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">terms</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">fn</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
            <span class="n">extra</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">fn</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">terms</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">fn</span> <span class="o">==</span> <span class="n">tan</span><span class="p">:</span>
                    <span class="n">extra</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">sin</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
                    <span class="n">extra</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">cos</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">fn</span> <span class="ow">in</span> <span class="p">[</span><span class="n">sin</span><span class="p">,</span> <span class="n">cos</span><span class="p">]</span> <span class="ow">and</span> <span class="n">tan</span> <span class="ow">in</span> <span class="n">fs</span><span class="p">:</span>
                    <span class="n">extra</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">tan</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">fn</span> <span class="o">==</span> <span class="n">tanh</span><span class="p">:</span>
                    <span class="n">extra</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">sinh</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
                    <span class="n">extra</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">cosh</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">fn</span> <span class="ow">in</span> <span class="p">[</span><span class="n">sinh</span><span class="p">,</span> <span class="n">cosh</span><span class="p">]</span> <span class="ow">and</span> <span class="n">tanh</span> <span class="ow">in</span> <span class="n">fs</span><span class="p">:</span>
                    <span class="n">extra</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">tanh</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
            <span class="n">terms</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">extra</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">gcd</span><span class="o">*</span><span class="n">Mul</span><span class="p">(</span><span class="o">*</span><span class="n">key</span><span class="p">)</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">build_ideal</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">terms</span><span class="p">)</span>
            <span class="n">res</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
            <span class="n">newgens</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">fn</span><span class="p">(</span><span class="n">v</span><span class="o">*</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">fn</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">terms</span><span class="p">))</span>

        <span class="c1"># Add generators for compound expressions from iterables</span>
        <span class="k">for</span> <span class="n">fn</span><span class="p">,</span> <span class="n">args</span> <span class="ow">in</span> <span class="n">iterables</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fn</span> <span class="o">==</span> <span class="n">tan</span><span class="p">:</span>
                <span class="c1"># Tan expressions are recovered from sin and cos.</span>
                <span class="n">iterables</span><span class="o">.</span><span class="n">extend</span><span class="p">([(</span><span class="n">sin</span><span class="p">,</span> <span class="n">args</span><span class="p">),</span> <span class="p">(</span><span class="n">cos</span><span class="p">,</span> <span class="n">args</span><span class="p">)])</span>
            <span class="k">elif</span> <span class="n">fn</span> <span class="o">==</span> <span class="n">tanh</span><span class="p">:</span>
                <span class="c1"># Tanh expressions are recovered from sihn and cosh.</span>
                <span class="n">iterables</span><span class="o">.</span><span class="n">extend</span><span class="p">([(</span><span class="n">sinh</span><span class="p">,</span> <span class="n">args</span><span class="p">),</span> <span class="p">(</span><span class="n">cosh</span><span class="p">,</span> <span class="n">args</span><span class="p">)])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dummys</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;d:</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">),</span> <span class="n">cls</span><span class="o">=</span><span class="n">Dummy</span><span class="p">)</span>
                <span class="n">expr</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span> <span class="n">Add</span><span class="p">(</span><span class="o">*</span><span class="n">dummys</span><span class="p">))</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">trig</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">dummys</span><span class="p">,</span> <span class="n">args</span><span class="p">)))</span>
                <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fn</span><span class="p">(</span><span class="n">Add</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">))</span> <span class="o">-</span> <span class="n">expr</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">myI</span> <span class="ow">in</span> <span class="n">gens</span><span class="p">:</span>
            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">myI</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">freegens</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">myI</span><span class="p">)</span>
            <span class="n">newgens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">myI</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">res</span><span class="p">,</span> <span class="n">freegens</span><span class="p">,</span> <span class="n">newgens</span>

    <span class="n">myI</span> <span class="o">=</span> <span class="n">Dummy</span><span class="p">(</span><span class="s1">&#39;I&#39;</span><span class="p">)</span>
    <span class="n">expr</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">S</span><span class="o">.</span><span class="n">ImaginaryUnit</span><span class="p">,</span> <span class="n">myI</span><span class="p">)</span>
    <span class="n">subs</span> <span class="o">=</span> <span class="p">[(</span><span class="n">myI</span><span class="p">,</span> <span class="n">S</span><span class="o">.</span><span class="n">ImaginaryUnit</span><span class="p">)]</span>

    <span class="n">num</span><span class="p">,</span> <span class="n">denom</span> <span class="o">=</span> <span class="n">cancel</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span><span class="o">.</span><span class="n">as_numer_denom</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="p">(</span><span class="n">pnum</span><span class="p">,</span> <span class="n">pdenom</span><span class="p">),</span> <span class="n">opt</span> <span class="o">=</span> <span class="n">parallel_poly_from_expr</span><span class="p">([</span><span class="n">num</span><span class="p">,</span> <span class="n">denom</span><span class="p">])</span>
    <span class="k">except</span> <span class="n">PolificationFailed</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">expr</span>
    <span class="n">debug</span><span class="p">(</span><span class="s1">&#39;initial gens:&#39;</span><span class="p">,</span> <span class="n">opt</span><span class="o">.</span><span class="n">gens</span><span class="p">)</span>
    <span class="n">ideal</span><span class="p">,</span> <span class="n">freegens</span><span class="p">,</span> <span class="n">gens</span> <span class="o">=</span> <span class="n">analyse_gens</span><span class="p">(</span><span class="n">opt</span><span class="o">.</span><span class="n">gens</span><span class="p">,</span> <span class="n">hints</span><span class="p">)</span>
    <span class="n">debug</span><span class="p">(</span><span class="s1">&#39;ideal:&#39;</span><span class="p">,</span> <span class="n">ideal</span><span class="p">)</span>
    <span class="n">debug</span><span class="p">(</span><span class="s1">&#39;new gens:&#39;</span><span class="p">,</span> <span class="n">gens</span><span class="p">,</span> <span class="s2">&quot; -- len&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">gens</span><span class="p">))</span>
    <span class="n">debug</span><span class="p">(</span><span class="s1">&#39;free gens:&#39;</span><span class="p">,</span> <span class="n">freegens</span><span class="p">,</span> <span class="s2">&quot; -- len&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">gens</span><span class="p">))</span>
    <span class="c1"># NOTE we force the domain to be ZZ to stop polys from injecting generators</span>
    <span class="c1">#      (which is usually a sign of a bug in the way we build the ideal)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">gens</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">expr</span>
    <span class="n">G</span> <span class="o">=</span> <span class="n">groebner</span><span class="p">(</span><span class="n">ideal</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">,</span> <span class="n">gens</span><span class="o">=</span><span class="n">gens</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">ZZ</span><span class="p">)</span>
    <span class="n">debug</span><span class="p">(</span><span class="s1">&#39;groebner basis:&#39;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">G</span><span class="p">),</span> <span class="s2">&quot; -- len&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">G</span><span class="p">))</span>

    <span class="c1"># If our fraction is a polynomial in the free generators, simplify all</span>
    <span class="c1"># coefficients separately:</span>

    <span class="kn">from</span> <span class="nn">sympy.simplify.ratsimp</span> <span class="kn">import</span> <span class="n">ratsimpmodprime</span>

    <span class="k">if</span> <span class="n">freegens</span> <span class="ow">and</span> <span class="n">pdenom</span><span class="o">.</span><span class="n">has_only_gens</span><span class="p">(</span><span class="o">*</span><span class="nb">set</span><span class="p">(</span><span class="n">gens</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">pdenom</span><span class="o">.</span><span class="n">gens</span><span class="p">)):</span>
        <span class="n">num</span> <span class="o">=</span> <span class="n">Poly</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">gens</span><span class="o">=</span><span class="n">gens</span><span class="o">+</span><span class="n">freegens</span><span class="p">)</span><span class="o">.</span><span class="n">eject</span><span class="p">(</span><span class="o">*</span><span class="n">gens</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">monom</span><span class="p">,</span> <span class="n">coeff</span> <span class="ow">in</span> <span class="n">num</span><span class="o">.</span><span class="n">terms</span><span class="p">():</span>
            <span class="n">ourgens</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">parallel_poly_from_expr</span><span class="p">([</span><span class="n">coeff</span><span class="p">,</span> <span class="n">denom</span><span class="p">])[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">gens</span><span class="p">)</span>
            <span class="c1"># We compute the transitive closure of all generators that can</span>
            <span class="c1"># be reached from our generators through relations in the ideal.</span>
            <span class="n">changed</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">while</span> <span class="n">changed</span><span class="p">:</span>
                <span class="n">changed</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">ideal</span><span class="p">:</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="n">Poly</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">ourgens</span><span class="o">.</span><span class="n">issuperset</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">gens</span><span class="p">)</span> <span class="ow">and</span> \
                       <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">has_only_gens</span><span class="p">(</span><span class="o">*</span><span class="nb">set</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">gens</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">ourgens</span><span class="p">)):</span>
                        <span class="n">changed</span> <span class="o">=</span> <span class="bp">True</span>
                        <span class="n">ourgens</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">exclude</span><span class="p">()</span><span class="o">.</span><span class="n">gens</span><span class="p">)</span>
            <span class="c1"># NOTE preserve order!</span>
            <span class="n">realgens</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">gens</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ourgens</span><span class="p">]</span>
            <span class="c1"># The generators of the ideal have now been (implicitely) split</span>
            <span class="c1"># into two groups: those involving ourgens and those that don&#39;t.</span>
            <span class="c1"># Since we took the transitive closure above, these two groups</span>
            <span class="c1"># live in subgrings generated by a *disjoint* set of variables.</span>
            <span class="c1"># Any sensible groebner basis algorithm will preserve this disjoint</span>
            <span class="c1"># structure (i.e. the elements of the groebner basis can be split</span>
            <span class="c1"># similarly), and and the two subsets of the groebner basis then</span>
            <span class="c1"># form groebner bases by themselves. (For the smaller generating</span>
            <span class="c1"># sets, of course.)</span>
            <span class="n">ourG</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span><span class="o">.</span><span class="n">as_expr</span><span class="p">()</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">G</span><span class="o">.</span><span class="n">polys</span> <span class="k">if</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">has_only_gens</span><span class="p">(</span><span class="o">*</span><span class="n">ourgens</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">gens</span><span class="p">))]</span>
            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Mul</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">a</span><span class="o">**</span><span class="n">b</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">freegens</span><span class="p">,</span> <span class="n">monom</span><span class="p">)])</span> <span class="o">*</span> \
                       <span class="n">ratsimpmodprime</span><span class="p">(</span><span class="n">coeff</span><span class="o">/</span><span class="n">denom</span><span class="p">,</span> <span class="n">ourG</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">,</span>
                                       <span class="n">gens</span><span class="o">=</span><span class="n">realgens</span><span class="p">,</span> <span class="n">quick</span><span class="o">=</span><span class="n">quick</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">ZZ</span><span class="p">,</span>
                                       <span class="n">polynomial</span><span class="o">=</span><span class="n">polynomial</span><span class="p">)</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">subs</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">Add</span><span class="p">(</span><span class="o">*</span><span class="n">res</span><span class="p">)</span>
        <span class="c1"># NOTE The following is simpler and has less assumptions on the</span>
        <span class="c1">#      groebner basis algorithm. If the above turns out to be broken,</span>
        <span class="c1">#      use this.</span>
        <span class="k">return</span> <span class="n">Add</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">Mul</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">a</span><span class="o">**</span><span class="n">b</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">freegens</span><span class="p">,</span> <span class="n">monom</span><span class="p">)])</span> <span class="o">*</span> \
                     <span class="n">ratsimpmodprime</span><span class="p">(</span><span class="n">coeff</span><span class="o">/</span><span class="n">denom</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">G</span><span class="p">),</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">,</span>
                                     <span class="n">gens</span><span class="o">=</span><span class="n">gens</span><span class="p">,</span> <span class="n">quick</span><span class="o">=</span><span class="n">quick</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">ZZ</span><span class="p">)</span>
                     <span class="k">for</span> <span class="n">monom</span><span class="p">,</span> <span class="n">coeff</span> <span class="ow">in</span> <span class="n">num</span><span class="o">.</span><span class="n">terms</span><span class="p">()])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ratsimpmodprime</span><span class="p">(</span>
            <span class="n">expr</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">G</span><span class="p">),</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">,</span> <span class="n">gens</span><span class="o">=</span><span class="n">freegens</span><span class="o">+</span><span class="n">gens</span><span class="p">,</span>
            <span class="n">quick</span><span class="o">=</span><span class="n">quick</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">ZZ</span><span class="p">,</span> <span class="n">polynomial</span><span class="o">=</span><span class="n">polynomial</span><span class="p">)</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">subs</span><span class="p">)</span>


<span class="n">_trigs</span> <span class="o">=</span> <span class="p">(</span><span class="n">TrigonometricFunction</span><span class="p">,</span> <span class="n">HyperbolicFunction</span><span class="p">)</span>


<div class="viewcode-block" id="trigsimp"><a class="viewcode-back" href="../../../modules/simplify/simplify.html#sympy.simplify.trigsimp.trigsimp">[docs]</a><span class="k">def</span> <span class="nf">trigsimp</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="o">**</span><span class="n">opts</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    reduces expression by using known trig identities</span>

<span class="sd">    Notes</span>
<span class="sd">    =====</span>

<span class="sd">    method:</span>
<span class="sd">    - Determine the method to use. Valid choices are &#39;matching&#39; (default),</span>
<span class="sd">    &#39;groebner&#39;, &#39;combined&#39;, and &#39;fu&#39;. If &#39;matching&#39;, simplify the</span>
<span class="sd">    expression recursively by targeting common patterns. If &#39;groebner&#39;, apply</span>
<span class="sd">    an experimental groebner basis algorithm. In this case further options</span>
<span class="sd">    are forwarded to ``trigsimp_groebner``, please refer to its docstring.</span>
<span class="sd">    If &#39;combined&#39;, first run the groebner basis algorithm with small</span>
<span class="sd">    default parameters, then run the &#39;matching&#39; algorithm. &#39;fu&#39; runs the</span>
<span class="sd">    collection of trigonometric transformations described by Fu, et al.</span>
<span class="sd">    (see the `fu` docstring).</span>


<span class="sd">    Examples</span>
<span class="sd">    ========</span>

<span class="sd">    &gt;&gt;&gt; from sympy import trigsimp, sin, cos, log</span>
<span class="sd">    &gt;&gt;&gt; from sympy.abc import x, y</span>
<span class="sd">    &gt;&gt;&gt; e = 2*sin(x)**2 + 2*cos(x)**2</span>
<span class="sd">    &gt;&gt;&gt; trigsimp(e)</span>
<span class="sd">    2</span>

<span class="sd">    Simplification occurs wherever trigonometric functions are located.</span>

<span class="sd">    &gt;&gt;&gt; trigsimp(log(e))</span>
<span class="sd">    log(2)</span>

<span class="sd">    Using `method=&quot;groebner&quot;` (or `&quot;combined&quot;`) might lead to greater</span>
<span class="sd">    simplification.</span>

<span class="sd">    The old trigsimp routine can be accessed as with method &#39;old&#39;.</span>

<span class="sd">    &gt;&gt;&gt; from sympy import coth, tanh</span>
<span class="sd">    &gt;&gt;&gt; t = 3*tanh(x)**7 - 2/coth(x)**7</span>
<span class="sd">    &gt;&gt;&gt; trigsimp(t, method=&#39;old&#39;) == t</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; trigsimp(t)</span>
<span class="sd">    tanh(x)**7</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">sympy.simplify.fu</span> <span class="kn">import</span> <span class="n">fu</span>

    <span class="n">expr</span> <span class="o">=</span> <span class="n">sympify</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">expr</span><span class="o">.</span><span class="n">_eval_trigsimp</span><span class="p">(</span><span class="o">**</span><span class="n">opts</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="n">old</span> <span class="o">=</span> <span class="n">opts</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;old&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">old</span><span class="p">:</span>
        <span class="n">opts</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;deep&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">recursive</span> <span class="o">=</span> <span class="n">opts</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;recursive&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">method</span> <span class="o">=</span> <span class="n">opts</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;method&#39;</span><span class="p">,</span> <span class="s1">&#39;matching&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;old&#39;</span>

    <span class="k">def</span> <span class="nf">groebnersimp</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="o">**</span><span class="n">opts</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">traverse</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">is_Atom</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">e</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">traverse</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">is_Function</span> <span class="ow">or</span> <span class="n">e</span><span class="o">.</span><span class="n">is_Pow</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">trigsimp_groebner</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">**</span><span class="n">opts</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">args</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">e</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="n">new</span> <span class="o">=</span> <span class="n">traverse</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">new</span><span class="p">,</span> <span class="n">Expr</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">new</span>
        <span class="k">return</span> <span class="n">trigsimp_groebner</span><span class="p">(</span><span class="n">new</span><span class="p">,</span> <span class="o">**</span><span class="n">opts</span><span class="p">)</span>

    <span class="n">trigsimpfunc</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;fu&#39;</span><span class="p">:</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">fu</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">**</span><span class="n">opts</span><span class="p">)),</span>
        <span class="s1">&#39;matching&#39;</span><span class="p">:</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">futrig</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span>
        <span class="s1">&#39;groebner&#39;</span><span class="p">:</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">groebnersimp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">**</span><span class="n">opts</span><span class="p">)),</span>
        <span class="s1">&#39;combined&#39;</span><span class="p">:</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">futrig</span><span class="p">(</span><span class="n">groebnersimp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span>
                               <span class="n">polynomial</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">hints</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">tan</span><span class="p">]))),</span>
        <span class="s1">&#39;old&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">trigsimp_old</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">**</span><span class="n">opts</span><span class="p">),</span>
                   <span class="p">}[</span><span class="n">method</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">trigsimpfunc</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">exptrigsimp</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">simplify</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simplifies exponential / trigonometric / hyperbolic functions.</span>
<span class="sd">    When ``simplify`` is True (default) the expression obtained after the</span>
<span class="sd">    simplification step will be then be passed through simplify to</span>
<span class="sd">    precondition it so the final transformations will be applied.</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>

<span class="sd">    &gt;&gt;&gt; from sympy import exptrigsimp, exp, cosh, sinh</span>
<span class="sd">    &gt;&gt;&gt; from sympy.abc import z</span>

<span class="sd">    &gt;&gt;&gt; exptrigsimp(exp(z) + exp(-z))</span>
<span class="sd">    2*cosh(z)</span>
<span class="sd">    &gt;&gt;&gt; exptrigsimp(cosh(z) - sinh(z))</span>
<span class="sd">    exp(-z)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">sympy.simplify.fu</span> <span class="kn">import</span> <span class="n">hyper_as_trig</span><span class="p">,</span> <span class="n">TR2i</span>
    <span class="kn">from</span> <span class="nn">sympy.simplify.simplify</span> <span class="kn">import</span> <span class="n">bottom_up</span>

    <span class="k">def</span> <span class="nf">exp_trig</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
        <span class="c1"># select the better of e, and e rewritten in terms of exp or trig</span>
        <span class="c1"># functions</span>
        <span class="n">choices</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="o">*</span><span class="n">_trigs</span><span class="p">):</span>
            <span class="n">choices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">rewrite</span><span class="p">(</span><span class="n">exp</span><span class="p">))</span>
        <span class="n">choices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">rewrite</span><span class="p">(</span><span class="n">cos</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="o">*</span><span class="n">choices</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">count_ops</span><span class="p">)</span>
    <span class="n">newexpr</span> <span class="o">=</span> <span class="n">bottom_up</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">exp_trig</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">simplify</span><span class="p">:</span>
        <span class="n">newexpr</span> <span class="o">=</span> <span class="n">newexpr</span><span class="o">.</span><span class="n">simplify</span><span class="p">()</span>

    <span class="c1"># conversion from exp to hyperbolic</span>
    <span class="n">ex</span> <span class="o">=</span> <span class="n">newexpr</span><span class="o">.</span><span class="n">atoms</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span> <span class="n">S</span><span class="o">.</span><span class="n">Exp1</span><span class="p">)</span>
    <span class="n">ex</span> <span class="o">=</span> <span class="p">[</span><span class="n">ei</span> <span class="k">for</span> <span class="n">ei</span> <span class="ow">in</span> <span class="n">ex</span> <span class="k">if</span> <span class="mi">1</span><span class="o">/</span><span class="n">ei</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ex</span><span class="p">]</span>
    <span class="c1">## sinh and cosh</span>
    <span class="k">for</span> <span class="n">ei</span> <span class="ow">in</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">e2</span> <span class="o">=</span> <span class="n">ei</span><span class="o">**-</span><span class="mi">2</span>
        <span class="k">if</span> <span class="n">e2</span> <span class="ow">in</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">e2</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">e2</span> <span class="ow">is</span> <span class="n">S</span><span class="o">.</span><span class="n">Exp1</span> <span class="k">else</span> <span class="n">S</span><span class="o">.</span><span class="n">Half</span>
            <span class="n">newexpr</span> <span class="o">=</span> <span class="n">newexpr</span><span class="o">.</span><span class="n">subs</span><span class="p">((</span><span class="n">e2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">ei</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">cosh</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
            <span class="n">newexpr</span> <span class="o">=</span> <span class="n">newexpr</span><span class="o">.</span><span class="n">subs</span><span class="p">((</span><span class="n">e2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">ei</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">sinh</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
    <span class="c1">## exp ratios to tan and tanh</span>
    <span class="k">for</span> <span class="n">ei</span> <span class="ow">in</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">n</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="n">ei</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ei</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">et</span> <span class="o">=</span> <span class="n">n</span><span class="o">/</span><span class="n">d</span>
        <span class="n">etinv</span> <span class="o">=</span> <span class="n">d</span><span class="o">/</span><span class="n">n</span>  <span class="c1"># not 1/et or else recursion errors arise</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">ei</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">ei</span><span class="o">.</span><span class="n">func</span> <span class="ow">is</span> <span class="n">exp</span> <span class="k">else</span> <span class="n">S</span><span class="o">.</span><span class="n">One</span>
        <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">is_Mul</span> <span class="ow">or</span> <span class="n">a</span> <span class="ow">is</span> <span class="n">S</span><span class="o">.</span><span class="n">ImaginaryUnit</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">as_coefficient</span><span class="p">(</span><span class="n">I</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">c</span><span class="p">:</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">S</span><span class="o">.</span><span class="n">ImaginaryUnit</span><span class="o">*</span><span class="n">tan</span><span class="p">(</span><span class="n">c</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">newexpr</span> <span class="o">=</span> <span class="n">newexpr</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">etinv</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="n">t</span><span class="p">)</span>
                <span class="n">newexpr</span> <span class="o">=</span> <span class="n">newexpr</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">et</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
                <span class="k">continue</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">tanh</span><span class="p">(</span><span class="n">a</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">newexpr</span> <span class="o">=</span> <span class="n">newexpr</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">etinv</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="n">t</span><span class="p">)</span>
        <span class="n">newexpr</span> <span class="o">=</span> <span class="n">newexpr</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">et</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>

    <span class="c1"># sin/cos and sinh/cosh ratios to tan and tanh, respectively</span>
    <span class="k">if</span> <span class="n">newexpr</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">HyperbolicFunction</span><span class="p">):</span>
        <span class="n">e</span><span class="p">,</span> <span class="n">f</span> <span class="o">=</span> <span class="n">hyper_as_trig</span><span class="p">(</span><span class="n">newexpr</span><span class="p">)</span>
        <span class="n">newexpr</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">TR2i</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">newexpr</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">TrigonometricFunction</span><span class="p">):</span>
        <span class="n">newexpr</span> <span class="o">=</span> <span class="n">TR2i</span><span class="p">(</span><span class="n">newexpr</span><span class="p">)</span>

    <span class="c1"># can we ever generate an I where there was none previously?</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">newexpr</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">I</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">expr</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">I</span><span class="p">)):</span>
        <span class="n">expr</span> <span class="o">=</span> <span class="n">newexpr</span>
    <span class="k">return</span> <span class="n">expr</span>

<span class="c1">#-------------------- the old trigsimp routines ---------------------</span>

<span class="k">def</span> <span class="nf">trigsimp_old</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="o">**</span><span class="n">opts</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    reduces expression by using known trig identities</span>

<span class="sd">    Notes</span>
<span class="sd">    =====</span>

<span class="sd">    deep:</span>
<span class="sd">    - Apply trigsimp inside all objects with arguments</span>

<span class="sd">    recursive:</span>
<span class="sd">    - Use common subexpression elimination (cse()) and apply</span>
<span class="sd">    trigsimp recursively (this is quite expensive if the</span>
<span class="sd">    expression is large)</span>

<span class="sd">    method:</span>
<span class="sd">    - Determine the method to use. Valid choices are &#39;matching&#39; (default),</span>
<span class="sd">    &#39;groebner&#39;, &#39;combined&#39;, &#39;fu&#39; and &#39;futrig&#39;. If &#39;matching&#39;, simplify the</span>
<span class="sd">    expression recursively by pattern matching. If &#39;groebner&#39;, apply an</span>
<span class="sd">    experimental groebner basis algorithm. In this case further options</span>
<span class="sd">    are forwarded to ``trigsimp_groebner``, please refer to its docstring.</span>
<span class="sd">    If &#39;combined&#39;, first run the groebner basis algorithm with small</span>
<span class="sd">    default parameters, then run the &#39;matching&#39; algorithm. &#39;fu&#39; runs the</span>
<span class="sd">    collection of trigonometric transformations described by Fu, et al.</span>
<span class="sd">    (see the `fu` docstring) while `futrig` runs a subset of Fu-transforms</span>
<span class="sd">    that mimic the behavior of `trigsimp`.</span>

<span class="sd">    compare:</span>
<span class="sd">    - show input and output from `trigsimp` and `futrig` when different,</span>
<span class="sd">    but returns the `trigsimp` value.</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>

<span class="sd">    &gt;&gt;&gt; from sympy import trigsimp, sin, cos, log, cosh, sinh, tan, cot</span>
<span class="sd">    &gt;&gt;&gt; from sympy.abc import x, y</span>
<span class="sd">    &gt;&gt;&gt; e = 2*sin(x)**2 + 2*cos(x)**2</span>
<span class="sd">    &gt;&gt;&gt; trigsimp(e, old=True)</span>
<span class="sd">    2</span>
<span class="sd">    &gt;&gt;&gt; trigsimp(log(e), old=True)</span>
<span class="sd">    log(2*sin(x)**2 + 2*cos(x)**2)</span>
<span class="sd">    &gt;&gt;&gt; trigsimp(log(e), deep=True, old=True)</span>
<span class="sd">    log(2)</span>

<span class="sd">    Using `method=&quot;groebner&quot;` (or `&quot;combined&quot;`) can sometimes lead to a lot</span>
<span class="sd">    more simplification:</span>

<span class="sd">    &gt;&gt;&gt; e = (-sin(x) + 1)/cos(x) + cos(x)/(-sin(x) + 1)</span>
<span class="sd">    &gt;&gt;&gt; trigsimp(e, old=True)</span>
<span class="sd">    (-sin(x) + 1)/cos(x) + cos(x)/(-sin(x) + 1)</span>
<span class="sd">    &gt;&gt;&gt; trigsimp(e, method=&quot;groebner&quot;, old=True)</span>
<span class="sd">    2/cos(x)</span>

<span class="sd">    &gt;&gt;&gt; trigsimp(1/cot(x)**2, compare=True, old=True)</span>
<span class="sd">          futrig: tan(x)**2</span>
<span class="sd">    cot(x)**(-2)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">old</span> <span class="o">=</span> <span class="n">expr</span>
    <span class="n">first</span> <span class="o">=</span> <span class="n">opts</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;first&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">first</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">expr</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="o">*</span><span class="n">_trigs</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">expr</span>

        <span class="n">trigsyms</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">free_symbols</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">expr</span><span class="o">.</span><span class="n">atoms</span><span class="p">(</span><span class="o">*</span><span class="n">_trigs</span><span class="p">)])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">trigsyms</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">separatevars</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">is_Mul</span><span class="p">:</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">separatevars</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="nb">dict</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="ow">or</span> <span class="n">d</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">expr</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="c1"># remove hollow factoring</span>
                    <span class="n">was</span> <span class="o">=</span> <span class="n">v</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="n">expand_mul</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    <span class="n">opts</span><span class="p">[</span><span class="s1">&#39;first&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
                    <span class="n">vnew</span> <span class="o">=</span> <span class="n">trigsimp</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="o">**</span><span class="n">opts</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">vnew</span> <span class="o">==</span> <span class="n">v</span><span class="p">:</span>
                        <span class="n">vnew</span> <span class="o">=</span> <span class="n">was</span>
                    <span class="n">expr</span> <span class="o">*=</span> <span class="n">vnew</span>
                <span class="n">old</span> <span class="o">=</span> <span class="n">expr</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">is_Add</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">trigsyms</span><span class="p">:</span>
                        <span class="n">r</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">as_independent</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">r</span><span class="p">:</span>
                            <span class="n">opts</span><span class="p">[</span><span class="s1">&#39;first&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
                            <span class="n">expr</span> <span class="o">=</span> <span class="n">r</span> <span class="o">+</span> <span class="n">trigsimp</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="o">**</span><span class="n">opts</span><span class="p">)</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">expr</span><span class="o">.</span><span class="n">is_Add</span><span class="p">:</span>
                                <span class="k">break</span>
                    <span class="n">old</span> <span class="o">=</span> <span class="n">expr</span>

    <span class="n">recursive</span> <span class="o">=</span> <span class="n">opts</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;recursive&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
    <span class="n">deep</span> <span class="o">=</span> <span class="n">opts</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;deep&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
    <span class="n">method</span> <span class="o">=</span> <span class="n">opts</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;method&#39;</span><span class="p">,</span> <span class="s1">&#39;matching&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">groebnersimp</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">deep</span><span class="p">,</span> <span class="o">**</span><span class="n">opts</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">traverse</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">is_Atom</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">e</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">traverse</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">is_Function</span> <span class="ow">or</span> <span class="n">e</span><span class="o">.</span><span class="n">is_Pow</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">trigsimp_groebner</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">**</span><span class="n">opts</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">args</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">e</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">deep</span><span class="p">:</span>
            <span class="n">ex</span> <span class="o">=</span> <span class="n">traverse</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">trigsimp_groebner</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="o">**</span><span class="n">opts</span><span class="p">)</span>

    <span class="n">trigsimpfunc</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;matching&#39;</span><span class="p">:</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">:</span> <span class="n">_trigsimp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">)),</span>
        <span class="s1">&#39;groebner&#39;</span><span class="p">:</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">:</span> <span class="n">groebnersimp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="o">**</span><span class="n">opts</span><span class="p">)),</span>
        <span class="s1">&#39;combined&#39;</span><span class="p">:</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">:</span> <span class="n">_trigsimp</span><span class="p">(</span><span class="n">groebnersimp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span>
                                       <span class="n">d</span><span class="p">,</span> <span class="n">polynomial</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">hints</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">tan</span><span class="p">]),</span>
                                   <span class="n">d</span><span class="p">))</span>
                   <span class="p">}[</span><span class="n">method</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">recursive</span><span class="p">:</span>
        <span class="n">w</span><span class="p">,</span> <span class="n">g</span> <span class="o">=</span> <span class="n">cse</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">trigsimpfunc</span><span class="p">(</span><span class="n">g</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">deep</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">w</span><span class="p">):</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">sub</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sub</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">trigsimpfunc</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">deep</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">g</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">trigsimpfunc</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">deep</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;compare&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">futrig</span><span class="p">(</span><span class="n">old</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">f</span> <span class="o">!=</span> <span class="n">result</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">futrig:&#39;</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">_dotrig</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Helper to tell whether ``a`` and ``b`` have the same sorts</span>
<span class="sd">    of symbols in them -- no need to test hyperbolic patterns against</span>
<span class="sd">    expressions that have no hyperbolics in them.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">a</span><span class="o">.</span><span class="n">func</span> <span class="o">==</span> <span class="n">b</span><span class="o">.</span><span class="n">func</span> <span class="ow">and</span> <span class="p">(</span>
        <span class="n">a</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">TrigonometricFunction</span><span class="p">)</span> <span class="ow">and</span> <span class="n">b</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">TrigonometricFunction</span><span class="p">)</span> <span class="ow">or</span>
        <span class="n">a</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">HyperbolicFunction</span><span class="p">)</span> <span class="ow">and</span> <span class="n">b</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">HyperbolicFunction</span><span class="p">))</span>


<span class="n">_trigpat</span> <span class="o">=</span> <span class="bp">None</span>
<span class="k">def</span> <span class="nf">_trigpats</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">_trigpat</span>
    <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;a b c&#39;</span><span class="p">,</span> <span class="n">cls</span><span class="o">=</span><span class="n">Wild</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">Wild</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="n">commutative</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="c1"># for the simplifications like sinh/cosh -&gt; tanh:</span>
    <span class="c1"># DO NOT REORDER THE FIRST 14 since these are assumed to be in this</span>
    <span class="c1"># order in _match_div_rewrite.</span>
    <span class="n">matchers_division</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">**</span><span class="n">c</span><span class="o">/</span><span class="n">cos</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">**</span><span class="n">c</span><span class="p">,</span> <span class="n">a</span><span class="o">*</span><span class="n">tan</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">**</span><span class="n">c</span><span class="p">,</span> <span class="n">sin</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="n">cos</span><span class="p">(</span><span class="n">b</span><span class="p">)),</span>
        <span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">tan</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">**</span><span class="n">c</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">**</span><span class="n">c</span><span class="p">,</span> <span class="n">a</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">**</span><span class="n">c</span><span class="p">,</span> <span class="n">sin</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="n">cos</span><span class="p">(</span><span class="n">b</span><span class="p">)),</span>
        <span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">cot</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">**</span><span class="n">c</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">**</span><span class="n">c</span><span class="p">,</span> <span class="n">a</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">**</span><span class="n">c</span><span class="p">,</span> <span class="n">sin</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="n">cos</span><span class="p">(</span><span class="n">b</span><span class="p">)),</span>
        <span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">tan</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">**</span><span class="n">c</span><span class="o">/</span><span class="n">sin</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">**</span><span class="n">c</span><span class="p">,</span> <span class="n">a</span><span class="o">/</span><span class="n">cos</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">**</span><span class="n">c</span><span class="p">,</span> <span class="n">sin</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="n">cos</span><span class="p">(</span><span class="n">b</span><span class="p">)),</span>
        <span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">cot</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">**</span><span class="n">c</span><span class="o">/</span><span class="n">cos</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">**</span><span class="n">c</span><span class="p">,</span> <span class="n">a</span><span class="o">/</span><span class="n">sin</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">**</span><span class="n">c</span><span class="p">,</span> <span class="n">sin</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="n">cos</span><span class="p">(</span><span class="n">b</span><span class="p">)),</span>
        <span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">cot</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">**</span><span class="n">c</span><span class="o">*</span><span class="n">tan</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">**</span><span class="n">c</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">sin</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="n">cos</span><span class="p">(</span><span class="n">b</span><span class="p">)),</span>
        <span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="p">(</span><span class="n">cos</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="n">c</span><span class="o">*</span><span class="p">(</span><span class="n">cos</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="n">c</span><span class="p">,</span>
            <span class="n">a</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="n">sin</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="n">c</span><span class="p">,</span> <span class="n">cos</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cos</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
        <span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="p">(</span><span class="n">sin</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="n">c</span><span class="o">*</span><span class="p">(</span><span class="n">sin</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="n">c</span><span class="p">,</span>
            <span class="n">a</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="n">cos</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="n">c</span><span class="p">,</span> <span class="n">sin</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sin</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>

        <span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">sinh</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">**</span><span class="n">c</span><span class="o">/</span><span class="n">cosh</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">**</span><span class="n">c</span><span class="p">,</span> <span class="n">a</span><span class="o">*</span><span class="n">tanh</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">**</span><span class="n">c</span><span class="p">,</span> <span class="n">S</span><span class="o">.</span><span class="n">One</span><span class="p">,</span> <span class="n">S</span><span class="o">.</span><span class="n">One</span><span class="p">),</span>
        <span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">tanh</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">**</span><span class="n">c</span><span class="o">*</span><span class="n">cosh</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">**</span><span class="n">c</span><span class="p">,</span> <span class="n">a</span><span class="o">*</span><span class="n">sinh</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">**</span><span class="n">c</span><span class="p">,</span> <span class="n">S</span><span class="o">.</span><span class="n">One</span><span class="p">,</span> <span class="n">S</span><span class="o">.</span><span class="n">One</span><span class="p">),</span>
        <span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">coth</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">**</span><span class="n">c</span><span class="o">*</span><span class="n">sinh</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">**</span><span class="n">c</span><span class="p">,</span> <span class="n">a</span><span class="o">*</span><span class="n">cosh</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">**</span><span class="n">c</span><span class="p">,</span> <span class="n">S</span><span class="o">.</span><span class="n">One</span><span class="p">,</span> <span class="n">S</span><span class="o">.</span><span class="n">One</span><span class="p">),</span>
        <span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">tanh</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">**</span><span class="n">c</span><span class="o">/</span><span class="n">sinh</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">**</span><span class="n">c</span><span class="p">,</span> <span class="n">a</span><span class="o">/</span><span class="n">cosh</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">**</span><span class="n">c</span><span class="p">,</span> <span class="n">S</span><span class="o">.</span><span class="n">One</span><span class="p">,</span> <span class="n">S</span><span class="o">.</span><span class="n">One</span><span class="p">),</span>
        <span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">coth</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">**</span><span class="n">c</span><span class="o">/</span><span class="n">cosh</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">**</span><span class="n">c</span><span class="p">,</span> <span class="n">a</span><span class="o">/</span><span class="n">sinh</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">**</span><span class="n">c</span><span class="p">,</span> <span class="n">S</span><span class="o">.</span><span class="n">One</span><span class="p">,</span> <span class="n">S</span><span class="o">.</span><span class="n">One</span><span class="p">),</span>
        <span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">coth</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">**</span><span class="n">c</span><span class="o">*</span><span class="n">tanh</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">**</span><span class="n">c</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">S</span><span class="o">.</span><span class="n">One</span><span class="p">,</span> <span class="n">S</span><span class="o">.</span><span class="n">One</span><span class="p">),</span>

        <span class="p">(</span><span class="n">c</span><span class="o">*</span><span class="p">(</span><span class="n">tanh</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">+</span> <span class="n">tanh</span><span class="p">(</span><span class="n">b</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">tanh</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="n">tanh</span><span class="p">(</span><span class="n">b</span><span class="p">)),</span>
            <span class="n">tanh</span><span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span><span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="n">S</span><span class="o">.</span><span class="n">One</span><span class="p">,</span> <span class="n">S</span><span class="o">.</span><span class="n">One</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="n">matchers_add</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">c</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">+</span> <span class="n">c</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">+</span> <span class="n">d</span><span class="p">,</span> <span class="n">sin</span><span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span><span class="o">*</span><span class="n">c</span> <span class="o">+</span> <span class="n">d</span><span class="p">),</span>
        <span class="p">(</span><span class="n">c</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">-</span> <span class="n">c</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">+</span> <span class="n">d</span><span class="p">,</span> <span class="n">cos</span><span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span><span class="o">*</span><span class="n">c</span> <span class="o">+</span> <span class="n">d</span><span class="p">),</span>
        <span class="p">(</span><span class="n">c</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">-</span> <span class="n">c</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">+</span> <span class="n">d</span><span class="p">,</span> <span class="n">sin</span><span class="p">(</span><span class="n">a</span> <span class="o">-</span> <span class="n">b</span><span class="p">)</span><span class="o">*</span><span class="n">c</span> <span class="o">+</span> <span class="n">d</span><span class="p">),</span>
        <span class="p">(</span><span class="n">c</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">+</span> <span class="n">c</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">+</span> <span class="n">d</span><span class="p">,</span> <span class="n">cos</span><span class="p">(</span><span class="n">a</span> <span class="o">-</span> <span class="n">b</span><span class="p">)</span><span class="o">*</span><span class="n">c</span> <span class="o">+</span> <span class="n">d</span><span class="p">),</span>
        <span class="p">(</span><span class="n">c</span><span class="o">*</span><span class="n">sinh</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="n">cosh</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">+</span> <span class="n">c</span><span class="o">*</span><span class="n">sinh</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">*</span><span class="n">cosh</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">+</span> <span class="n">d</span><span class="p">,</span> <span class="n">sinh</span><span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span><span class="o">*</span><span class="n">c</span> <span class="o">+</span> <span class="n">d</span><span class="p">),</span>
        <span class="p">(</span><span class="n">c</span><span class="o">*</span><span class="n">cosh</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="n">cosh</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">+</span> <span class="n">c</span><span class="o">*</span><span class="n">sinh</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="n">sinh</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">+</span> <span class="n">d</span><span class="p">,</span> <span class="n">cosh</span><span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span><span class="o">*</span><span class="n">c</span> <span class="o">+</span> <span class="n">d</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="c1"># for cos(x)**2 + sin(x)**2 -&gt; 1</span>
    <span class="n">matchers_identity</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">a</span> <span class="o">-</span> <span class="n">a</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span>
        <span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">tan</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">a</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">cos</span><span class="p">(</span><span class="n">b</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">a</span><span class="p">),</span>
        <span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">cot</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">a</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">sin</span><span class="p">(</span><span class="n">b</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">a</span><span class="p">),</span>
        <span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">b</span> <span class="o">+</span> <span class="n">c</span><span class="p">),</span> <span class="n">a</span><span class="o">*</span><span class="p">(</span><span class="n">sin</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="n">sin</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">b</span><span class="p">))),</span>
        <span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">b</span> <span class="o">+</span> <span class="n">c</span><span class="p">),</span> <span class="n">a</span><span class="o">*</span><span class="p">(</span><span class="n">cos</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">-</span> <span class="n">sin</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">c</span><span class="p">))),</span>
        <span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">tan</span><span class="p">(</span><span class="n">b</span> <span class="o">+</span> <span class="n">c</span><span class="p">),</span> <span class="n">a</span><span class="o">*</span><span class="p">((</span><span class="n">tan</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">+</span> <span class="n">tan</span><span class="p">(</span><span class="n">c</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">tan</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">*</span><span class="n">tan</span><span class="p">(</span><span class="n">c</span><span class="p">)))),</span>

        <span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">sinh</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">a</span><span class="o">*</span><span class="n">cosh</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">a</span><span class="p">),</span>
        <span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">tanh</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">a</span> <span class="o">-</span> <span class="n">a</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">cosh</span><span class="p">(</span><span class="n">b</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span>
        <span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">coth</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">a</span> <span class="o">+</span> <span class="n">a</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">sinh</span><span class="p">(</span><span class="n">b</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span>
        <span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">sinh</span><span class="p">(</span><span class="n">b</span> <span class="o">+</span> <span class="n">c</span><span class="p">),</span> <span class="n">a</span><span class="o">*</span><span class="p">(</span><span class="n">sinh</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">*</span><span class="n">cosh</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="n">sinh</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">*</span><span class="n">cosh</span><span class="p">(</span><span class="n">b</span><span class="p">))),</span>
        <span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">cosh</span><span class="p">(</span><span class="n">b</span> <span class="o">+</span> <span class="n">c</span><span class="p">),</span> <span class="n">a</span><span class="o">*</span><span class="p">(</span><span class="n">cosh</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">*</span><span class="n">cosh</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="n">sinh</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">*</span><span class="n">sinh</span><span class="p">(</span><span class="n">c</span><span class="p">))),</span>
        <span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">tanh</span><span class="p">(</span><span class="n">b</span> <span class="o">+</span> <span class="n">c</span><span class="p">),</span> <span class="n">a</span><span class="o">*</span><span class="p">((</span><span class="n">tanh</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">+</span> <span class="n">tanh</span><span class="p">(</span><span class="n">c</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">tanh</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">*</span><span class="n">tanh</span><span class="p">(</span><span class="n">c</span><span class="p">)))),</span>

    <span class="p">)</span>

    <span class="c1"># Reduce any lingering artifacts, such as sin(x)**2 changing</span>
    <span class="c1"># to 1-cos(x)**2 when sin(x)**2 was &quot;simpler&quot;</span>
    <span class="n">artifacts</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">a</span> <span class="o">-</span> <span class="n">a</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">c</span><span class="p">,</span> <span class="n">a</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">c</span><span class="p">,</span> <span class="n">cos</span><span class="p">),</span>
        <span class="p">(</span><span class="n">a</span> <span class="o">-</span> <span class="n">a</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">cos</span><span class="p">(</span><span class="n">b</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">c</span><span class="p">,</span> <span class="o">-</span><span class="n">a</span><span class="o">*</span><span class="n">tan</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">c</span><span class="p">,</span> <span class="n">cos</span><span class="p">),</span>
        <span class="p">(</span><span class="n">a</span> <span class="o">-</span> <span class="n">a</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">sin</span><span class="p">(</span><span class="n">b</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">c</span><span class="p">,</span> <span class="o">-</span><span class="n">a</span><span class="o">*</span><span class="n">cot</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">c</span><span class="p">,</span> <span class="n">sin</span><span class="p">),</span>

        <span class="p">(</span><span class="n">a</span> <span class="o">-</span> <span class="n">a</span><span class="o">*</span><span class="n">cosh</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">c</span><span class="p">,</span> <span class="o">-</span><span class="n">a</span><span class="o">*</span><span class="n">sinh</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">c</span><span class="p">,</span> <span class="n">cosh</span><span class="p">),</span>
        <span class="p">(</span><span class="n">a</span> <span class="o">-</span> <span class="n">a</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">cosh</span><span class="p">(</span><span class="n">b</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">c</span><span class="p">,</span> <span class="n">a</span><span class="o">*</span><span class="n">tanh</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">c</span><span class="p">,</span> <span class="n">cosh</span><span class="p">),</span>
        <span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">a</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">sinh</span><span class="p">(</span><span class="n">b</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">c</span><span class="p">,</span> <span class="n">a</span><span class="o">*</span><span class="n">coth</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">c</span><span class="p">,</span> <span class="n">sinh</span><span class="p">),</span>

        <span class="c1"># same as above but with noncommutative prefactor</span>
        <span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">d</span> <span class="o">-</span> <span class="n">a</span><span class="o">*</span><span class="n">d</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">c</span><span class="p">,</span> <span class="n">a</span><span class="o">*</span><span class="n">d</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">c</span><span class="p">,</span> <span class="n">cos</span><span class="p">),</span>
        <span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">d</span> <span class="o">-</span> <span class="n">a</span><span class="o">*</span><span class="n">d</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">cos</span><span class="p">(</span><span class="n">b</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">c</span><span class="p">,</span> <span class="o">-</span><span class="n">a</span><span class="o">*</span><span class="n">d</span><span class="o">*</span><span class="n">tan</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">c</span><span class="p">,</span> <span class="n">cos</span><span class="p">),</span>
        <span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">d</span> <span class="o">-</span> <span class="n">a</span><span class="o">*</span><span class="n">d</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">sin</span><span class="p">(</span><span class="n">b</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">c</span><span class="p">,</span> <span class="o">-</span><span class="n">a</span><span class="o">*</span><span class="n">d</span><span class="o">*</span><span class="n">cot</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">c</span><span class="p">,</span> <span class="n">sin</span><span class="p">),</span>

        <span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">d</span> <span class="o">-</span> <span class="n">a</span><span class="o">*</span><span class="n">d</span><span class="o">*</span><span class="n">cosh</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">c</span><span class="p">,</span> <span class="o">-</span><span class="n">a</span><span class="o">*</span><span class="n">d</span><span class="o">*</span><span class="n">sinh</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">c</span><span class="p">,</span> <span class="n">cosh</span><span class="p">),</span>
        <span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">d</span> <span class="o">-</span> <span class="n">a</span><span class="o">*</span><span class="n">d</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">cosh</span><span class="p">(</span><span class="n">b</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">c</span><span class="p">,</span> <span class="n">a</span><span class="o">*</span><span class="n">d</span><span class="o">*</span><span class="n">tanh</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">c</span><span class="p">,</span> <span class="n">cosh</span><span class="p">),</span>
        <span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">d</span> <span class="o">+</span> <span class="n">a</span><span class="o">*</span><span class="n">d</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">sinh</span><span class="p">(</span><span class="n">b</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">c</span><span class="p">,</span> <span class="n">a</span><span class="o">*</span><span class="n">d</span><span class="o">*</span><span class="n">coth</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">c</span><span class="p">,</span> <span class="n">sinh</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="n">_trigpat</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">matchers_division</span><span class="p">,</span> <span class="n">matchers_add</span><span class="p">,</span>
        <span class="n">matchers_identity</span><span class="p">,</span> <span class="n">artifacts</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_trigpat</span>


<span class="k">def</span> <span class="nf">_replace_mul_fpowxgpow</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">rexp</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">rexph</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Helper for _match_div_rewrite.</span>

<span class="sd">    Replace f(b_)**c_*g(b_)**(rexp(c_)) with h(b)**rexph(c) if f(b_)</span>
<span class="sd">    and g(b_) are both positive or if c_ is an integer.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># assert expr.is_Mul and expr.is_commutative and f != g</span>
    <span class="n">fargs</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">gargs</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">expr</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">is_Pow</span> <span class="ow">or</span> <span class="n">x</span><span class="o">.</span><span class="n">func</span> <span class="ow">in</span> <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">g</span><span class="p">):</span>
            <span class="n">b</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">as_base_exp</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">is_positive</span> <span class="ow">or</span> <span class="n">e</span><span class="o">.</span><span class="n">is_integer</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">func</span> <span class="o">==</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">fargs</span><span class="p">[</span><span class="n">b</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">e</span>
                    <span class="k">continue</span>
                <span class="k">elif</span> <span class="n">b</span><span class="o">.</span><span class="n">func</span> <span class="o">==</span> <span class="n">g</span><span class="p">:</span>
                    <span class="n">gargs</span><span class="p">[</span><span class="n">b</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">e</span>
                    <span class="k">continue</span>
        <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">common</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">fargs</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">gargs</span><span class="p">)</span>
    <span class="n">hit</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">while</span> <span class="n">common</span><span class="p">:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="n">fe</span> <span class="o">=</span> <span class="n">fargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">ge</span> <span class="o">=</span> <span class="n">gargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fe</span> <span class="o">==</span> <span class="n">rexp</span><span class="p">(</span><span class="n">ge</span><span class="p">):</span>
            <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">h</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="o">**</span><span class="n">rexph</span><span class="p">(</span><span class="n">fe</span><span class="p">))</span>
            <span class="n">hit</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">fe</span>
            <span class="n">gargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">ge</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">hit</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">expr</span>
    <span class="k">while</span> <span class="n">fargs</span><span class="p">:</span>
        <span class="n">key</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span class="n">fargs</span><span class="o">.</span><span class="n">popitem</span><span class="p">()</span>
        <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="o">**</span><span class="n">e</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">gargs</span><span class="p">:</span>
        <span class="n">key</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span class="n">gargs</span><span class="o">.</span><span class="n">popitem</span><span class="p">()</span>
        <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">g</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="o">**</span><span class="n">e</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Mul</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>


<span class="n">_idn</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span>
<span class="n">_midn</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="n">x</span>
<span class="n">_one</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">S</span><span class="o">.</span><span class="n">One</span>

<span class="k">def</span> <span class="nf">_match_div_rewrite</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;helper for __trigsimp&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">expr</span> <span class="o">=</span> <span class="n">_replace_mul_fpowxgpow</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">sin</span><span class="p">,</span> <span class="n">cos</span><span class="p">,</span>
            <span class="n">_midn</span><span class="p">,</span> <span class="n">tan</span><span class="p">,</span> <span class="n">_idn</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">expr</span> <span class="o">=</span> <span class="n">_replace_mul_fpowxgpow</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">tan</span><span class="p">,</span> <span class="n">cos</span><span class="p">,</span>
            <span class="n">_idn</span><span class="p">,</span> <span class="n">sin</span><span class="p">,</span> <span class="n">_idn</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">expr</span> <span class="o">=</span> <span class="n">_replace_mul_fpowxgpow</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">cot</span><span class="p">,</span> <span class="n">sin</span><span class="p">,</span>
            <span class="n">_idn</span><span class="p">,</span> <span class="n">cos</span><span class="p">,</span> <span class="n">_idn</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">expr</span> <span class="o">=</span> <span class="n">_replace_mul_fpowxgpow</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">tan</span><span class="p">,</span> <span class="n">sin</span><span class="p">,</span>
            <span class="n">_midn</span><span class="p">,</span> <span class="n">cos</span><span class="p">,</span> <span class="n">_midn</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">expr</span> <span class="o">=</span> <span class="n">_replace_mul_fpowxgpow</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">cot</span><span class="p">,</span> <span class="n">cos</span><span class="p">,</span>
            <span class="n">_midn</span><span class="p">,</span> <span class="n">sin</span><span class="p">,</span> <span class="n">_midn</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
        <span class="n">expr</span> <span class="o">=</span> <span class="n">_replace_mul_fpowxgpow</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">cot</span><span class="p">,</span> <span class="n">tan</span><span class="p">,</span>
            <span class="n">_idn</span><span class="p">,</span> <span class="n">_one</span><span class="p">,</span> <span class="n">_idn</span><span class="p">)</span>
    <span class="c1"># i in (6, 7) is skipped</span>
    <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">8</span><span class="p">:</span>
        <span class="n">expr</span> <span class="o">=</span> <span class="n">_replace_mul_fpowxgpow</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">sinh</span><span class="p">,</span> <span class="n">cosh</span><span class="p">,</span>
            <span class="n">_midn</span><span class="p">,</span> <span class="n">tanh</span><span class="p">,</span> <span class="n">_idn</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">9</span><span class="p">:</span>
        <span class="n">expr</span> <span class="o">=</span> <span class="n">_replace_mul_fpowxgpow</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">tanh</span><span class="p">,</span> <span class="n">cosh</span><span class="p">,</span>
            <span class="n">_idn</span><span class="p">,</span> <span class="n">sinh</span><span class="p">,</span> <span class="n">_idn</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">10</span><span class="p">:</span>
        <span class="n">expr</span> <span class="o">=</span> <span class="n">_replace_mul_fpowxgpow</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">coth</span><span class="p">,</span> <span class="n">sinh</span><span class="p">,</span>
            <span class="n">_idn</span><span class="p">,</span> <span class="n">cosh</span><span class="p">,</span> <span class="n">_idn</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">11</span><span class="p">:</span>
        <span class="n">expr</span> <span class="o">=</span> <span class="n">_replace_mul_fpowxgpow</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">tanh</span><span class="p">,</span> <span class="n">sinh</span><span class="p">,</span>
            <span class="n">_midn</span><span class="p">,</span> <span class="n">cosh</span><span class="p">,</span> <span class="n">_midn</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">12</span><span class="p">:</span>
        <span class="n">expr</span> <span class="o">=</span> <span class="n">_replace_mul_fpowxgpow</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">coth</span><span class="p">,</span> <span class="n">cosh</span><span class="p">,</span>
            <span class="n">_midn</span><span class="p">,</span> <span class="n">sinh</span><span class="p">,</span> <span class="n">_midn</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">13</span><span class="p">:</span>
        <span class="n">expr</span> <span class="o">=</span> <span class="n">_replace_mul_fpowxgpow</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">coth</span><span class="p">,</span> <span class="n">tanh</span><span class="p">,</span>
            <span class="n">_idn</span><span class="p">,</span> <span class="n">_one</span><span class="p">,</span> <span class="n">_idn</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">return</span> <span class="n">expr</span>


<span class="k">def</span> <span class="nf">_trigsimp</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">deep</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="c1"># protect the cache from non-trig patterns; we only allow</span>
    <span class="c1"># trig patterns to enter the cache</span>
    <span class="k">if</span> <span class="n">expr</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="o">*</span><span class="n">_trigs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">__trigsimp</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">deep</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">expr</span>


<span class="nd">@cacheit</span>
<span class="k">def</span> <span class="nf">__trigsimp</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">deep</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;recursive helper for trigsimp&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">sympy.simplify.fu</span> <span class="kn">import</span> <span class="n">TR10i</span>

    <span class="k">if</span> <span class="n">_trigpat</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">_trigpats</span><span class="p">()</span>
    <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">matchers_division</span><span class="p">,</span> <span class="n">matchers_add</span><span class="p">,</span> \
    <span class="n">matchers_identity</span><span class="p">,</span> <span class="n">artifacts</span> <span class="o">=</span> <span class="n">_trigpat</span>

    <span class="k">if</span> <span class="n">expr</span><span class="o">.</span><span class="n">is_Mul</span><span class="p">:</span>
        <span class="c1"># do some simplifications like sin/cos -&gt; tan:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">expr</span><span class="o">.</span><span class="n">is_commutative</span><span class="p">:</span>
            <span class="n">com</span><span class="p">,</span> <span class="n">nc</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">args_cnc</span><span class="p">()</span>
            <span class="n">expr</span> <span class="o">=</span> <span class="n">_trigsimp</span><span class="p">(</span><span class="n">Mul</span><span class="o">.</span><span class="n">_from_args</span><span class="p">(</span><span class="n">com</span><span class="p">),</span> <span class="n">deep</span><span class="p">)</span><span class="o">*</span><span class="n">Mul</span><span class="o">.</span><span class="n">_from_args</span><span class="p">(</span><span class="n">nc</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">simp</span><span class="p">,</span> <span class="n">ok1</span><span class="p">,</span> <span class="n">ok2</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">matchers_division</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">_dotrig</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">pattern</span><span class="p">):</span>
                    <span class="k">continue</span>

                <span class="n">newexpr</span> <span class="o">=</span> <span class="n">_match_div_rewrite</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">newexpr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">newexpr</span> <span class="o">!=</span> <span class="n">expr</span><span class="p">:</span>
                        <span class="n">expr</span> <span class="o">=</span> <span class="n">newexpr</span>
                        <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">continue</span>

                <span class="c1"># use SymPy matching instead</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">res</span> <span class="ow">and</span> <span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">res</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">is_integer</span><span class="p">:</span>
                        <span class="n">ok</span> <span class="o">=</span> <span class="n">ok1</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="o">.</span><span class="n">is_positive</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="n">ok</span> <span class="o">=</span> <span class="n">ok2</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="o">.</span><span class="n">is_positive</span><span class="p">:</span>
                            <span class="k">continue</span>
                    <span class="c1"># if &quot;a&quot; contains any of trig or hyperbolic funcs with</span>
                    <span class="c1"># argument &quot;b&quot; then skip the simplification</span>
                    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">res</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">res</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">atoms</span><span class="p">(</span>
                            <span class="n">TrigonometricFunction</span><span class="p">,</span> <span class="n">HyperbolicFunction</span><span class="p">)):</span>
                        <span class="k">continue</span>
                    <span class="c1"># simplify and finish:</span>
                    <span class="n">expr</span> <span class="o">=</span> <span class="n">simp</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
                    <span class="k">break</span>  <span class="c1"># process below</span>

    <span class="k">if</span> <span class="n">expr</span><span class="o">.</span><span class="n">is_Add</span><span class="p">:</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">expr</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">term</span><span class="o">.</span><span class="n">is_commutative</span><span class="p">:</span>
                <span class="n">com</span><span class="p">,</span> <span class="n">nc</span> <span class="o">=</span> <span class="n">term</span><span class="o">.</span><span class="n">args_cnc</span><span class="p">()</span>
                <span class="n">nc</span> <span class="o">=</span> <span class="n">Mul</span><span class="o">.</span><span class="n">_from_args</span><span class="p">(</span><span class="n">nc</span><span class="p">)</span>
                <span class="n">term</span> <span class="o">=</span> <span class="n">Mul</span><span class="o">.</span><span class="n">_from_args</span><span class="p">(</span><span class="n">com</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nc</span> <span class="o">=</span> <span class="n">S</span><span class="o">.</span><span class="n">One</span>
            <span class="n">term</span> <span class="o">=</span> <span class="n">_trigsimp</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">deep</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">matchers_identity</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">term</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">term</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
                    <span class="k">break</span>
            <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">term</span><span class="o">*</span><span class="n">nc</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">args</span> <span class="o">!=</span> <span class="n">expr</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">expr</span> <span class="o">=</span> <span class="n">Add</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
            <span class="n">expr</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">expand</span><span class="p">(</span><span class="n">expr</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="n">count_ops</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">expr</span><span class="o">.</span><span class="n">is_Add</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">matchers_add</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">_dotrig</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">pattern</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="n">expr</span> <span class="o">=</span> <span class="n">TR10i</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">expr</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">HyperbolicFunction</span><span class="p">):</span>
                    <span class="n">res</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
                    <span class="c1"># if &quot;d&quot; contains any trig or hyperbolic funcs with</span>
                    <span class="c1"># argument &quot;a&quot; or &quot;b&quot; then skip the simplification;</span>
                    <span class="c1"># this isn&#39;t perfect -- see tests</span>
                    <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="p">(</span><span class="n">a</span> <span class="ow">in</span> <span class="n">res</span> <span class="ow">and</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">res</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">any</span><span class="p">(</span>
                        <span class="n">w</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">res</span><span class="p">[</span><span class="n">b</span><span class="p">])</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">res</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">atoms</span><span class="p">(</span>
                            <span class="n">TrigonometricFunction</span><span class="p">,</span> <span class="n">HyperbolicFunction</span><span class="p">)):</span>
                        <span class="k">continue</span>
                    <span class="n">expr</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
                    <span class="k">break</span>

        <span class="c1"># Reduce any lingering artifacts, such as sin(x)**2 changing</span>
        <span class="c1"># to 1 - cos(x)**2 when sin(x)**2 was &quot;simpler&quot;</span>
        <span class="k">for</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">ex</span> <span class="ow">in</span> <span class="n">artifacts</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">_dotrig</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">pattern</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="c1"># Substitute a new wild that excludes some function(s)</span>
            <span class="c1"># to help influence a better match. This is because</span>
            <span class="c1"># sometimes, for example, &#39;a&#39; would match sec(x)**2</span>
            <span class="n">a_t</span> <span class="o">=</span> <span class="n">Wild</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="p">[</span><span class="n">ex</span><span class="p">])</span>
            <span class="n">pattern</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">a_t</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">a_t</span><span class="p">)</span>

            <span class="n">m</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
            <span class="n">was</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">while</span> <span class="n">m</span> <span class="ow">and</span> <span class="n">was</span> <span class="o">!=</span> <span class="n">expr</span><span class="p">:</span>
                <span class="n">was</span> <span class="o">=</span> <span class="n">expr</span>
                <span class="k">if</span> <span class="n">m</span><span class="p">[</span><span class="n">a_t</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> \
                        <span class="o">-</span><span class="n">m</span><span class="p">[</span><span class="n">a_t</span><span class="p">]</span> <span class="ow">in</span> <span class="n">m</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">args</span> <span class="ow">or</span> <span class="n">m</span><span class="p">[</span><span class="n">a_t</span><span class="p">]</span> <span class="o">+</span> <span class="n">m</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="k">if</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">m</span> <span class="ow">and</span> <span class="n">m</span><span class="p">[</span><span class="n">a_t</span><span class="p">]</span><span class="o">*</span><span class="n">m</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">+</span> <span class="n">m</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">expr</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
                <span class="n">m</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
                <span class="n">m</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">S</span><span class="o">.</span><span class="n">Zero</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">expr</span><span class="o">.</span><span class="n">is_Mul</span> <span class="ow">or</span> <span class="n">expr</span><span class="o">.</span><span class="n">is_Pow</span> <span class="ow">or</span> <span class="n">deep</span> <span class="ow">and</span> <span class="n">expr</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">expr</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">_trigsimp</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">deep</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">expr</span><span class="o">.</span><span class="n">args</span><span class="p">])</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">expr</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="o">*</span><span class="n">_trigs</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span>
        <span class="n">e</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">atoms</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span>
        <span class="n">new</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">rewrite</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span> <span class="n">deep</span><span class="o">=</span><span class="n">deep</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">new</span> <span class="o">==</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span>
        <span class="n">fnew</span> <span class="o">=</span> <span class="n">factor</span><span class="p">(</span><span class="n">new</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fnew</span> <span class="o">!=</span> <span class="n">new</span><span class="p">:</span>
            <span class="n">new</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">new</span><span class="p">,</span> <span class="n">factor</span><span class="p">(</span><span class="n">new</span><span class="p">)],</span> <span class="n">key</span><span class="o">=</span><span class="n">count_ops</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># if all exp that were introduced disappeared then accept it</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">new</span><span class="o">.</span><span class="n">atoms</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span> <span class="o">-</span> <span class="n">e</span><span class="p">):</span>
            <span class="n">expr</span> <span class="o">=</span> <span class="n">new</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">return</span> <span class="n">expr</span>
<span class="c1">#------------------- end of old trigsimp routines --------------------</span>


<span class="k">def</span> <span class="nf">futrig</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return simplified ``e`` using Fu-like transformations.</span>
<span class="sd">    This is not the &quot;Fu&quot; algorithm. This is called by default</span>
<span class="sd">    from ``trigsimp``. By default, hyperbolics subexpressions</span>
<span class="sd">    will be simplified, but this can be disabled by setting</span>
<span class="sd">    ``hyper=False``.</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>

<span class="sd">    &gt;&gt;&gt; from sympy import trigsimp, tan, sinh, tanh</span>
<span class="sd">    &gt;&gt;&gt; from sympy.simplify.trigsimp import futrig</span>
<span class="sd">    &gt;&gt;&gt; from sympy.abc import x</span>
<span class="sd">    &gt;&gt;&gt; trigsimp(1/tan(x)**2)</span>
<span class="sd">    tan(x)**(-2)</span>

<span class="sd">    &gt;&gt;&gt; futrig(sinh(x)/tanh(x))</span>
<span class="sd">    cosh(x)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">sympy.simplify.fu</span> <span class="kn">import</span> <span class="n">hyper_as_trig</span>
    <span class="kn">from</span> <span class="nn">sympy.simplify.simplify</span> <span class="kn">import</span> <span class="n">bottom_up</span>

    <span class="n">e</span> <span class="o">=</span> <span class="n">sympify</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">Basic</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">e</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">e</span>

    <span class="n">old</span> <span class="o">=</span> <span class="n">e</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">bottom_up</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">_futrig</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;hyper&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span> <span class="ow">and</span> <span class="n">e</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">HyperbolicFunction</span><span class="p">):</span>
        <span class="n">e</span><span class="p">,</span> <span class="n">f</span> <span class="o">=</span> <span class="n">hyper_as_trig</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="n">e</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">_futrig</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">e</span> <span class="o">!=</span> <span class="n">old</span> <span class="ow">and</span> <span class="n">e</span><span class="o">.</span><span class="n">is_Mul</span> <span class="ow">and</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">is_Rational</span><span class="p">:</span>
        <span class="c1"># redistribute leading coeff on 2-arg Add</span>
        <span class="n">e</span> <span class="o">=</span> <span class="n">Mul</span><span class="p">(</span><span class="o">*</span><span class="n">e</span><span class="o">.</span><span class="n">as_coeff_Mul</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">e</span>


<span class="k">def</span> <span class="nf">_futrig</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Helper for futrig.&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">sympy.simplify.fu</span> <span class="kn">import</span> <span class="p">(</span>
        <span class="n">TR1</span><span class="p">,</span> <span class="n">TR2</span><span class="p">,</span> <span class="n">TR3</span><span class="p">,</span> <span class="n">TR2i</span><span class="p">,</span> <span class="n">TR10</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">TR10i</span><span class="p">,</span>
        <span class="n">TR8</span><span class="p">,</span> <span class="n">TR6</span><span class="p">,</span> <span class="n">TR15</span><span class="p">,</span> <span class="n">TR16</span><span class="p">,</span> <span class="n">TR111</span><span class="p">,</span> <span class="n">TR5</span><span class="p">,</span> <span class="n">TRmorrie</span><span class="p">,</span> <span class="n">TR11</span><span class="p">,</span> <span class="n">TR14</span><span class="p">,</span> <span class="n">TR22</span><span class="p">,</span>
        <span class="n">TR12</span><span class="p">)</span>
    <span class="kn">from</span> <span class="nn">sympy.core.compatibility</span> <span class="kn">import</span> <span class="n">_nodes</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">e</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">TrigonometricFunction</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">e</span>

    <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">is_Mul</span><span class="p">:</span>
        <span class="n">coeff</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">as_independent</span><span class="p">(</span><span class="n">TrigonometricFunction</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">coeff</span> <span class="o">=</span> <span class="n">S</span><span class="o">.</span><span class="n">One</span>

    <span class="n">Lops</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">x</span><span class="o">.</span><span class="n">count_ops</span><span class="p">(),</span> <span class="n">_nodes</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">args</span><span class="p">),</span> <span class="n">x</span><span class="o">.</span><span class="n">is_Add</span><span class="p">)</span>
    <span class="n">trigs</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">TrigonometricFunction</span><span class="p">)</span>

    <span class="n">tree</span> <span class="o">=</span> <span class="p">[</span><span class="n">identity</span><span class="p">,</span>
        <span class="p">(</span>
        <span class="n">TR3</span><span class="p">,</span>  <span class="c1"># canonical angles</span>
        <span class="n">TR1</span><span class="p">,</span>  <span class="c1"># sec-csc -&gt; cos-sin</span>
        <span class="n">TR12</span><span class="p">,</span>  <span class="c1"># expand tan of sum</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">_eapply</span><span class="p">(</span><span class="n">factor</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">trigs</span><span class="p">),</span>
        <span class="n">TR2</span><span class="p">,</span>  <span class="c1"># tan-cot -&gt; sin-cos</span>
        <span class="p">[</span><span class="n">identity</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">_eapply</span><span class="p">(</span><span class="n">_mexpand</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">trigs</span><span class="p">)],</span>
        <span class="n">TR2i</span><span class="p">,</span>  <span class="c1"># sin-cos ratio -&gt; tan</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">_eapply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">factor</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">normal</span><span class="p">()),</span> <span class="n">x</span><span class="p">,</span> <span class="n">trigs</span><span class="p">),</span>
        <span class="n">TR14</span><span class="p">,</span>  <span class="c1"># factored identities</span>
        <span class="n">TR5</span><span class="p">,</span>  <span class="c1"># sin-pow -&gt; cos_pow</span>
        <span class="n">TR10</span><span class="p">,</span>  <span class="c1"># sin-cos of sums -&gt; sin-cos prod</span>
        <span class="n">TR11</span><span class="p">,</span> <span class="n">TR6</span><span class="p">,</span> <span class="c1"># reduce double angles and rewrite cos pows</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">_eapply</span><span class="p">(</span><span class="n">factor</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">trigs</span><span class="p">),</span>
        <span class="n">TR14</span><span class="p">,</span>  <span class="c1"># factored powers of identities</span>
        <span class="p">[</span><span class="n">identity</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">_eapply</span><span class="p">(</span><span class="n">_mexpand</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">trigs</span><span class="p">)],</span>
        <span class="n">TRmorrie</span><span class="p">,</span>
        <span class="n">TR10i</span><span class="p">,</span>  <span class="c1"># sin-cos products &gt; sin-cos of sums</span>
        <span class="p">[</span><span class="n">identity</span><span class="p">,</span> <span class="n">TR8</span><span class="p">],</span>  <span class="c1"># sin-cos products -&gt; sin-cos of sums</span>
        <span class="p">[</span><span class="n">identity</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">TR2i</span><span class="p">(</span><span class="n">TR2</span><span class="p">(</span><span class="n">x</span><span class="p">))],</span>  <span class="c1"># tan -&gt; sin-cos -&gt; tan</span>
        <span class="p">[</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">_eapply</span><span class="p">(</span><span class="n">expand_mul</span><span class="p">,</span> <span class="n">TR5</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">trigs</span><span class="p">),</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">_eapply</span><span class="p">(</span>
                <span class="n">expand_mul</span><span class="p">,</span> <span class="n">TR15</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">trigs</span><span class="p">)],</span> <span class="c1"># pos/neg powers of sin</span>
        <span class="p">[</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span>  <span class="n">_eapply</span><span class="p">(</span><span class="n">expand_mul</span><span class="p">,</span> <span class="n">TR6</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">trigs</span><span class="p">),</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span>  <span class="n">_eapply</span><span class="p">(</span>
                <span class="n">expand_mul</span><span class="p">,</span> <span class="n">TR16</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">trigs</span><span class="p">)],</span> <span class="c1"># pos/neg powers of cos</span>
        <span class="n">TR111</span><span class="p">,</span>  <span class="c1"># tan, sin, cos to neg power -&gt; cot, csc, sec</span>
        <span class="p">[</span><span class="n">identity</span><span class="p">,</span> <span class="n">TR2i</span><span class="p">],</span>  <span class="c1"># sin-cos ratio to tan</span>
        <span class="p">[</span><span class="n">identity</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">_eapply</span><span class="p">(</span>
            <span class="n">expand_mul</span><span class="p">,</span> <span class="n">TR22</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">trigs</span><span class="p">)],</span>  <span class="c1"># tan-cot to sec-csc</span>
        <span class="n">TR1</span><span class="p">,</span> <span class="n">TR2</span><span class="p">,</span> <span class="n">TR2i</span><span class="p">,</span>
        <span class="p">[</span><span class="n">identity</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">_eapply</span><span class="p">(</span>
            <span class="n">factor_terms</span><span class="p">,</span> <span class="n">TR12</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">trigs</span><span class="p">)],</span>  <span class="c1"># expand tan of sum</span>
        <span class="p">)]</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">greedy</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">objective</span><span class="o">=</span><span class="n">Lops</span><span class="p">)(</span><span class="n">e</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">coeff</span><span class="o">*</span><span class="n">e</span>


<span class="k">def</span> <span class="nf">_is_Expr</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;_eapply helper to tell whether ``e`` and all its args</span>
<span class="sd">    are Exprs.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">Expr</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">_is_Expr</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_eapply</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">cond</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Apply ``func`` to ``e`` if all args are Exprs else only</span>
<span class="sd">    apply it to those args that *are* Exprs.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">Expr</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">e</span>
    <span class="k">if</span> <span class="n">_is_Expr</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">e</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="p">[</span>
        <span class="n">_eapply</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">ei</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">cond</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">cond</span><span class="p">(</span><span class="n">ei</span><span class="p">))</span> <span class="k">else</span> <span class="n">ei</span>
        <span class="k">for</span> <span class="n">ei</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">])</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/sympylogo.png" alt="Logo"/>
            </a></p><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2015 SymPy Development Team.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.4.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.7</a>
      
    </div>

    

    
  </body>
</html>